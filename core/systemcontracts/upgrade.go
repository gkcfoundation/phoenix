package systemcontracts

import (
	"encoding/hex"
	"fmt"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

type UpgradeConfig struct {
	BeforeUpgrade upgradeHook
	AfterUpgrade  upgradeHook
	ContractAddr  common.Address
	CommitUrl     string
	Code          string
}

type Upgrade struct {
	UpgradeName string
	Configs     []*UpgradeConfig
}

type upgradeHook func(blockNumber *big.Int, contractAddr common.Address, statedb *state.StateDB) error

const (
	mainNet    = "Mainnet" // mainNet
	//chapelNet  = "Chapel" // testNet
	//rialtoNet  = "Rialto" // testNet
	defaultNet = "Default"
)

var (
	GenesisHash common.Hash
	//upgrade config
	sposUpgrade = make(map[string]*Upgrade)

	//poseidonUpgrade = make(map[string]*Upgrade)
)

func init() {
	sposUpgrade[mainNet] = &Upgrade{
		UpgradeName: "spos",
		Configs: []*UpgradeConfig{
			{
				ContractAddr: common.HexToAddress(ValidatorFactoryContract),
				CommitUrl:    "TODO", // TODO
				Code:         "608060405234801561001057600080fd5b50610dc2806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c806327a50f72146100515780635d252d8314610093578063b41b196f146100e3578063c4e41b2214610109575b600080fd5b6100776004803603602081101561006757600080fd5b50356001600160a01b0316610123565b604080516001600160a01b039092168252519081900360200190f35b6100b9600480360360208110156100a957600080fd5b50356001600160a01b0316610141565b604080516001600160a01b0394851681529290931660208301528183015290519081900360600190f35b610077600480360360208110156100f957600080fd5b50356001600160a01b031661016f565b61011161022e565b60408051918252519081900360200190f35b6001600160a01b039081166000908152602081905260409020541690565b6000602081905290815260409020805460018201546002909201546001600160a01b03918216929091169083565b600080823360405161018090610342565b6001600160a01b03928316815291166020820152604080519182900301906000f0801580156101b3573d6000803e3d6000fd5b5090506101be61034f565b50604080516060810182526001600160a01b03808416825285811660208084018281524385870190815260009384529183905294909120925183549083166001600160a01b0319918216178455935160018401805491909316941693909317905590516002909101559050919050565b6000805b6001548110156102dd576102d36001828154811061024c57fe5b600091825260209182902060039091020154604080516318160ddd60e01b815290516001600160a01b03909216926318160ddd92600480840193829003018186803b15801561029a57600080fd5b505afa1580156102ae573d6000803e3d6000fd5b505050506040513d60208110156102c457600080fd5b5051839063ffffffff6102e116565b9150600101610232565b5090565b60008282018381101561033b576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b9392505050565b610a1e8061037083390190565b60408051606081018252600080825260208201819052918101919091529056fe608060405234801561001057600080fd5b50604051610a1e380380610a1e8339818101604052604081101561003357600080fd5b508051602090910151600480546001600160a01b039384166001600160a01b031991821617909155600580549390921692169190911790556109a48061007a6000396000f3fe6080604052600436106100a75760003560e01c80639f35c7e7116100645780639f35c7e7146101f8578063b69ef8a814610229578063c58eb72a1461023e578063d0e30db014610271578063dbfb867514610279578063e9fad8ee1461028e576100a7565b806318160ddd146101175780632e1a7d4d1461013e5780636375c1e31461016857806370a082311461017d57806377c7b8fc146101b05780637bf89c85146101c5575b3361011557600560009054906101000a90046001600160a01b03166001600160a01b031663ad728a426040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156100fc57600080fd5b505af1158015610110573d6000803e3d6000fd5b505050505b005b34801561012357600080fd5b5061012c6102a3565b60408051918252519081900360200190f35b34801561014a57600080fd5b506101156004803603602081101561016157600080fd5b50356102aa565b34801561017457600080fd5b5061012c6104db565b34801561018957600080fd5b5061012c600480360360208110156101a057600080fd5b50356001600160a01b03166104e1565b3480156101bc57600080fd5b5061012c610519565b3480156101d157600080fd5b5061012c600480360360208110156101e857600080fd5b50356001600160a01b031661055a565b34801561020457600080fd5b5061020d610575565b604080516001600160a01b039092168252519081900360200190f35b34801561023557600080fd5b5061012c610584565b34801561024a57600080fd5b5061012c6004803603602081101561026157600080fd5b50356001600160a01b0316610588565b6101156105a3565b34801561028557600080fd5b5061020d6106f2565b34801561029a57600080fd5b50610115610701565b6000545b90565b600081116102f3576040805162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b604482015290519081900360640190fd5b33600090815260036020526040902054811115610350576040805162461bcd60e51b8152602060048201526016602482015275616d6f756e7420657863656564732062616c616e636560501b604482015290519081900360640190fd5b600061037c600154610370610363610584565b859063ffffffff61071416565b9063ffffffff61077416565b3360009081526003602052604090205490915061039f908363ffffffff6107b616565b336000908152600360205260409020556001546103c2908263ffffffff6107b616565b6001553360009081526003602090815260408083205460029092528220546103f6919061037090869063ffffffff61071416565b33600090815260026020526040902054909150610419908263ffffffff6107b616565b336000908152600260205260408120919091555461043d908263ffffffff6107b616565b6000908155604051339184156108fc02918591818181858888f1935050505015801561046d573d6000803e3d6000fd5b50600560009054906101000a90046001600160a01b03166001600160a01b031663ad728a426040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156104be57600080fd5b505af11580156104d2573d6000803e3d6000fd5b50505050505050565b60015490565b6001546001600160a01b038216600090815260036020526040812054909161051391610370904763ffffffff61071416565b92915050565b60006105236104db565b61052f575060006102a7565b610555600154610370670de0b6b3a7640000610549610584565b9063ffffffff61071416565b905090565b6001600160a01b031660009081526003602052604090205490565b6004546001600160a01b031681565b4790565b6001600160a01b031660009081526002602052604090205490565b34806105e9576040805162461bcd60e51b815260206004820152601060248201526f043616e6e6f74206465706f73697420360841b604482015290519081900360640190fd5b60006105f3610584565b600154909150600090610607575081610623565b610620826103706001548661071490919063ffffffff16565b90505b33600090815260036020526040902054610643908263ffffffff6107f816565b33600090815260036020526040902055600154610666908263ffffffff6107f816565b60015533600090815260026020526040902054610689908463ffffffff6107f816565b33600090815260026020526040812091909155546106ad908463ffffffff6107f816565b6000908155600554604080516356b9452160e11b815290516001600160a01b039092169263ad728a429260048084019382900301818387803b1580156104be57600080fd5b6005546001600160a01b031681565b61071261070d336104e1565b6102aa565b565b60008261072357506000610513565b8282028284828161073057fe5b041461076d5760405162461bcd60e51b815260040180806020018281038252602181526020018061094f6021913960400191505060405180910390fd5b9392505050565b600061076d83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610852565b600061076d83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f7700008152506108f4565b60008282018381101561076d576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600081836108de5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156108a357818101518382015260200161088b565b50505050905090810190601f1680156108d05780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385816108ea57fe5b0495945050505050565b600081848411156109465760405162461bcd60e51b81526020600482018181528351602484015283519092839260449091019190850190808383600083156108a357818101518382015260200161088b565b50505090039056fe536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a265627a7a72315820f7322acb374a5be1870027324ee02e27fecac1e9ed9e99a99720a9353db717ac64736f6c63430005100032a265627a7a72315820e4893551aaf9f65237d3c950a7ac42ef0c19c41f98f52c51eecf99fb76c777f364736f6c63430005100032",
			},
			{
				ContractAddr: common.HexToAddress(ValidatorHubContract),
				CommitUrl:    "TODO", // TODO
				Code:         "608060405268056bc75e2d63100000600090815567016345785d8a0000600155600255600880546001600160a01b03191661100917905534801561004257600080fd5b506118f5806100526000396000f3fe60806040526004361061019c5760003560e01c8063ab8f6ffe116100ec578063d7368fd61161008a578063f2c298be11610064578063f2c298be14610589578063fa2fab22146105f9578063fa52c7d81461060e578063facd743b146106fc5761019c565b8063d7368fd61461055f578063d7cbdc231461022c578063e79a198f146105745761019c565b8063c4e41b22116100c6578063c4e41b22146104ed578063c90fc8ee14610502578063c96be4cb14610517578063d6bdb89f1461054a5761019c565b8063ab8f6ffe1461045c578063ad728a42146104c1578063b7ab4db5146104d85761019c565b806355dad0c1116101595780638a11d7c9116101335780638a11d7c91461032d57806395468d26146103ff578063a0730c2d14610414578063a8232cca146104295761019c565b806355dad0c1146102bc5780636e37d599146102d157806374ec29a0146102e65761019c565b80631040bd47146101a15780631110fdff146101e657806311260a5f1461022c578063440cc90d146102415780634754857c1461027457806352747f7b146102a7575b600080fd5b3480156101ad57600080fd5b506101d4600480360360208110156101c457600080fd5b50356001600160a01b031661072f565b60408051918252519081900360200190f35b3480156101f257600080fd5b506102106004803603602081101561020957600080fd5b503561074d565b604080516001600160a01b039092168252519081900360200190f35b34801561023857600080fd5b506101d4610774565b34801561024d57600080fd5b506101d46004803603602081101561026457600080fd5b50356001600160a01b0316610779565b34801561028057600080fd5b506102106004803603602081101561029757600080fd5b50356001600160a01b0316610797565b3480156102b357600080fd5b506101d46107b2565b3480156102c857600080fd5b506101d46107b7565b3480156102dd57600080fd5b506101d46107bd565b3480156102f257600080fd5b506103196004803603602081101561030957600080fd5b50356001600160a01b03166107ca565b604080519115158252519081900360200190f35b34801561033957600080fd5b506103606004803603602081101561035057600080fd5b50356001600160a01b031661083e565b6040518080602001856001600160a01b03166001600160a01b03168152602001848152602001838152602001828103825286818151815260200191508051906020019080838360005b838110156103c15781810151838201526020016103a9565b50505050905090810190601f1680156103ee5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b34801561040b57600080fd5b506101d46109cd565b34801561042057600080fd5b506101d46109d9565b34801561043557600080fd5b506103196004803603602081101561044c57600080fd5b50356001600160a01b0316610ab9565b34801561046857600080fd5b50610471610ace565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156104ad578181015183820152602001610495565b505050509050019250505060405180910390f35b3480156104cd57600080fd5b506104d6610c62565b005b3480156104e457600080fd5b50610471610dec565b3480156104f957600080fd5b506101d4610f4a565b34801561050e57600080fd5b506101d4610f51565b34801561052357600080fd5b506104d66004803603602081101561053a57600080fd5b50356001600160a01b0316610f57565b34801561055657600080fd5b506101d4610ffe565b34801561056b57600080fd5b50610210611004565b34801561058057600080fd5b506104d6611013565b6104d66004803603602081101561059f57600080fd5b8101906020810181356401000000008111156105ba57600080fd5b8201836020820111156105cc57600080fd5b803590602001918460018302840111640100000000831117156105ee57600080fd5b50909250905061127e565b34801561060557600080fd5b506101d461154b565b34801561061a57600080fd5b506106416004803603602081101561063157600080fd5b50356001600160a01b0316611551565b6040518089815260200180602001888152602001878152602001868152602001856001600160a01b03166001600160a01b03168152602001848152602001838152602001828103825289818151815260200191508051906020019080838360005b838110156106ba5781810151838201526020016106a2565b50505050905090810190601f1680156106e75780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b34801561070857600080fd5b506103196004803603602081101561071f57600080fd5b50356001600160a01b0316611628565b6001600160a01b031660009081526007602052604090206002015490565b6003818154811061075a57fe5b6000918252602090912001546001600160a01b0316905081565b600181565b6001600160a01b031660009081526007602052604090206003015490565b6006602052600090815260409020546001600160a01b031681565b606481565b60025481565b68056bc75e2d6310000081565b6001600160a01b038116600090815260076020526040812054606443049081148061080f57506001600160a01b03831660009081526007602052604090206001015481145b801561083757506001600160a01b038316600090815260046020526040902060060154600111155b9392505050565b33600090815260056020526040812054606091908190819060ff166108a1576040805162461bcd60e51b81526020600482015260146024820152731c995b185e595c88191bc81b9bdd08195e1a5cdd60621b604482015290519081900360640190fd5b6108a9611774565b336000908152600460209081526040918290208251610100808201855282548252600180840180548751600293821615909402600019011691909104601f81018690048602830186019096528582529194929385810193919291908301828280156109555780601f1061092a57610100808354040283529160200191610955565b820191906000526020600020905b81548152906001019060200180831161093857829003601f168201915b50505091835250506002820154602080830191909152600383015460408301526004830154606083015260058301546001600160a01b03166080830152600683015460a08084019190915260079093015460c092830152830151918301519083015160e0909301519199909850919650945092505050565b67016345785d8a000081565b6000805b600354811015610ab5576000600382815481106109f657fe5b60009182526020918290200154604080516303a7614d60e51b81526001600160a01b0390921660048301819052905190935030926374ec29a09260248082019391829003018186803b158015610a4b57600080fd5b505afa158015610a5f573d6000803e3d6000fd5b505050506040513d6020811015610a7557600080fd5b505115610aac576001600160a01b038116600090815260046020526040902060060154610aa990849063ffffffff61164616565b92505b506001016109dd565b5090565b60056020526000908152604090205460ff1681565b606080600380549050604051908082528060200260200182016040528015610b00578160200160208202803683370190505b5090506000805b600354811015610be357600060038281548110610b2057fe5b60009182526020918290200154604080516303a7614d60e51b81526001600160a01b0390921660048301819052905190935030926374ec29a09260248082019391829003018186803b158015610b7557600080fd5b505afa158015610b89573d6000803e3d6000fd5b505050506040513d6020811015610b9f57600080fd5b505115610bda5780848480600101955081518110610bb957fe5b60200260200101906001600160a01b031690816001600160a01b0316815250505b50600101610b07565b5080604051908082528060200260200182016040528015610c0e578160200160208202803683370190505b50925060005b81811015610c5c57828181518110610c2857fe5b6020026020010151848281518110610c3c57fe5b6001600160a01b0390921660209283029190910190910152600101610c14565b50505090565b336000908152600660205260409020546001600160a01b031680610cbf576040805162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206164647265737360881b604482015290519081900360640190fd5b6000336001600160a01b03166318160ddd6040518163ffffffff1660e01b815260040160206040518083038186803b158015610cfa57600080fd5b505afa158015610d0e573d6000803e3d6000fd5b505050506040513d6020811015610d2457600080fd5b50516001600160a01b038316600090815260046020526040902060060154600954919250610d6a918391610d5e919063ffffffff6116a016565b9063ffffffff61164616565b6009556001600160a01b03821660008181526004602081905260408083206006810186905543600790910155805163c96be4cb60e01b8152918201939093529151309263c96be4cb92602480830193919282900301818387803b158015610dd057600080fd5b505af1158015610de4573d6000803e3d6000fd5b505050505050565b606080600380549050604051908082528060200260200182016040528015610e1e578160200160208202803683370190505b5090506000805b600354811015610ed1576005600060038381548110610e4057fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16151560011415610ec95760038181548110610e7f57fe5b600091825260209091200154835160018401936001600160a01b039092169185918110610ea857fe5b60200260200101906001600160a01b031690816001600160a01b0316815250505b600101610e25565b5080604051908082528060200260200182016040528015610efc578160200160208202803683370190505b50925060005b81811015610c5c57828181518110610f1657fe5b6020026020010151848281518110610f2a57fe5b6001600160a01b0390921660209283029190910190910152600101610f02565b6009545b90565b60095481565b3a1580610f6357503330145b610fab576040805162461bcd60e51b81526020600482015260146024820152736761737072696365206973206e6f74207a65726f60601b604482015290519081900360640190fd5b6001600160a01b0381166000908152600760205260409020436002820181905560018083015460649092049190820114610ff957600180830180548455828201905560038301805490910190555b505050565b60015481565b6008546001600160a01b031681565b3360009081526005602052604090205460ff1661106e576040805162461bcd60e51b81526020600482015260146024820152731c995b185e595c88191bc81b9bdd08195e1a5cdd60621b604482015290519081900360640190fd5b611076611774565b336000908152600460209081526040918290208251610100808201855282548252600180840180548751600293821615909402600019011691909104601f81018690048602830186019096528582529194929385810193919291908301828280156111225780601f106110f757610100808354040283529160200191611122565b820191906000526020600020905b81548152906001019060200180831161110557829003601f168201915b505050505081526020016002820154815260200160038201548152602001600482015481526020016005820160009054906101000a90046001600160a01b03166001600160a01b03166001600160a01b03168152602001600682015481526020016007820154815250509050336001600160a01b03166108fc6111b6836080015184606001516116a090919063ffffffff16565b6040518115909202916000818181858888f193505050501580156111de573d6000803e3d6000fd5b50336000908152600560209081526040808320805460ff19169055600490915281208181559061121160018301826117c2565b5060006002820181905560038201819055600482018190556005820180546001600160a01b0319169055600682018190556007909101556040805133815290517f619f345390d298d89d3baccce7a123e9ac22207eeec8a83aeebf9eba44664ea49181900360200190a150565b3360009081526005602052604090205460ff16156112db576040805162461bcd60e51b81526020600482015260156024820152741c995b185e595c88185b1c9958591e48195e1a5cdd605a1b604482015290519081900360640190fd5b600054341461131b5760405162461bcd60e51b815260040180806020018281038252602681526020018061189a6026913960400191505060405180910390fd5b6008546040805163b41b196f60e01b815233600482015290516000926001600160a01b03169163b41b196f91602480830192602092919082900301818787803b15801561136757600080fd5b505af115801561137b573d6000803e3d6000fd5b505050506040513d602081101561139157600080fd5b505160408051610100810182526002805460018101909155815281516020601f870181900481028201810190935285815292935091828201918690869081908401838280828437600092018290525093855250504360208085019190915282546040808601919091526001805460608701526001600160a01b038816608087015260a0860185905260c0909501859052338452600482529092208451815584830151805191946114479490860193500190611809565b50604082810151600283015560608301516003808401919091556080840151600484015560a0840151600580850180546001600160a01b039384166001600160a01b03199182161790915560c087015160068088019190915560e0909701516007909601959095553360008181526020928352858120805460ff1916600190811790915585549081019095557fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b9094018054871682179055918716835294855290829020805490931681179092558051918252517f25a3947661275401ddf9dbcc3b788430de7af5d6c5cb75007ac2f1aa491895c9929181900390910190a1505050565b60005481565b6004602090815260009182526040918290208054600180830180548651600293821615610100026000190190911692909204601f8101869004860283018601909652858252919492939092908301828280156115ee5780601f106115c3576101008083540402835291602001916115ee565b820191906000526020600020905b8154815290600101906020018083116115d157829003601f168201915b50505060028401546003850154600486015460058701546006880154600790980154969793969295509093506001600160a01b0316919088565b6001600160a01b031660009081526005602052604090205460ff1690565b600082820183811015610837576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600061083783836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f7700008152506000818484111561176c5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611731578181015183820152602001611719565b50505050905090810190601f16801561175e5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b604051806101000160405280600081526020016060815260200160008152602001600081526020016000815260200160006001600160a01b0316815260200160008152602001600081525090565b50805460018160011615610100020316600290046000825580601f106117e85750611806565b601f016020900490600052602060002090810190611806919061187f565b50565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061184a57805160ff1916838001178555611877565b82800160010185558215611877579182015b8281111561187757825182559160200191906001019061185c565b50610ab59291505b610f4e91905b80821115610ab5576000815560010161188556fe72656769737465722076616c7565206973206e6f742065786163746c79207468652073616d65a26469706673582212202b1736104877d5667ae441aa8fb57970570ad6372860e11f64e229f14b79976064736f6c63430006040033",
			},
		},
	}

	//sposUpgrade[chapelNet] = &Upgrade{
	//	UpgradeName: "ramanujan",
	//	Configs: []*UpgradeConfig{
	//	},
	//}
	//
	//poseidonUpgrade[chapelNet] = &Upgrade{
	//	UpgradeName: "niels",
	//	Configs: []*UpgradeConfig{
	//	},
	//}
}

func UpgradeBuildInSystemContract(config *params.ChainConfig, blockNumber *big.Int, statedb *state.StateDB) {
	if config == nil || blockNumber == nil || statedb == nil {
		return
	}
	var network string
	switch GenesisHash { //	TODO
	/* Add mainnet genesis hash */
	case params.PhoenixGenesisHash:
		network = mainNet
	//case params.SPosGenesisHash:
	//	network = mainNet
	//case params.ChapelGenesisHash:
	//	network = chapelNet
	//case params.RialtoGenesisHash:
	//	network = rialtoNet
	default:
		network = defaultNet
	}

	logger := log.New("system-contract-upgrade", network)
	if config.IsSpos(blockNumber) {
		applySystemContractUpgrade(sposUpgrade[network], blockNumber, statedb, logger)
	}

	//if config.IsPoseidon(blockNumber) {
	//	applySystemContractUpgrade(poseidonUpgrade[network], blockNumber, statedb, logger)
	//}

	/*
		apply other upgrades
	*/
}

func applySystemContractUpgrade(upgrade *Upgrade, blockNumber *big.Int, statedb *state.StateDB, logger log.Logger) {
	if upgrade == nil {
		logger.Info("Empty upgrade config", "height", blockNumber.String())
		return
	}

	logger.Info(fmt.Sprintf("Apply upgrade %s at height %d", upgrade.UpgradeName, blockNumber.Int64()))
	for _, cfg := range upgrade.Configs {
		logger.Info(fmt.Sprintf("Upgrade contract %s to commit %s", cfg.ContractAddr.String(), cfg.CommitUrl))

		if cfg.BeforeUpgrade != nil {
			err := cfg.BeforeUpgrade(blockNumber, cfg.ContractAddr, statedb)
			if err != nil {
				panic(fmt.Errorf("contract address: %s, execute beforeUpgrade error: %s", cfg.ContractAddr.String(), err.Error()))
			}
		}

		newContractCode, err := hex.DecodeString(cfg.Code)
		if err != nil {
			panic(fmt.Errorf("failed to decode new contract code: %s", err.Error()))
		}
		statedb.SetCode(cfg.ContractAddr, newContractCode)

		if cfg.AfterUpgrade != nil {
			err := cfg.AfterUpgrade(blockNumber, cfg.ContractAddr, statedb)
			if err != nil {
				panic(fmt.Errorf("contract address: %s, execute afterUpgrade error: %s", cfg.ContractAddr.String(), err.Error()))
			}
		}
	}
}
